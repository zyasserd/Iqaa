<div id="boo"></div>
<script src="https://npmcdn.com/vexflow@3.0.9/releases/vexflow-debug.js"></script>
<script>

    // ["4/4:8:DTsT|DsTs"]
    let iqaas = {
        "Maqsum": {time: [4, 4], unit: 8, rhythm: "DTsT|DsTs"},
        "Samai Thaqil": {time: [10, 8], unit: 8, rhythm: "Dss|Ts|DD|Tss"},
        "Fox": {time: [2, 4], unit: 8, rhythm: "DTDT"},
        "aqsaq": {time: [9, 8], unit: 8, rhythm: "Ds|Ts|DD|TsT"}
    };
    // validity check: unit/denominator * numerator = number of D+T

    let iqaa = iqaas["aqsaq"];
    // let iqaa = {time: [1, 128], unit: 128, rhythm: "D"};

    notesString = "";
    for (c of iqaa.rhythm) {
        if (c.toLowerCase() == "d") {
            notesString += `B4/${iqaa.unit}[stem="up"],`;
        } else if (c.toLowerCase() == "t") {
            notesString += `B4/${iqaa.unit}[stem="down"],`;
        } else if (c.toLowerCase() == 's') {
            notesString += `B4/${iqaa.unit}/r[stem="down"],`;
        } else {
            // error if not '|'
        }
    }

    // notesString = 'B4/8[stem="up"], B4/4[stem="down"], B4/8[stem="down"], B4/q[stem="up"], B4/q[stem="down"],';

    // **********************************************

    var vf = new Vex.Flow.Factory({renderer: {elementId: 'boo', width: 600, height: 150}});
    var score = vf.EasyScore();
    var system = vf.System();

    let notes = score.notes(notesString);

    var st = system.addStave({
        voices: [
            score.voice(notes, { time: `${iqaa.time[0]}/${iqaa.time[1]}` })
        ]
    }).addClef('percussion').addTimeSignature(`${iqaa.time[0]}/${iqaa.time[1]}`, 0/* sets padding to 0*/);
    
    system.parts[0].stave.options.line_config = [
        { visible: false },
        { visible: false },
        { visible: true },
        { visible: false },
        { visible: false },
    ];

    // for (let i = 0; i < notes.length; i++) {
    //     notes[i].addAnnotation(0, new Vex.Flow.Annotation(iqaa.rhythm.replaceAll('|', '')[i]).setFont('gonville', 14).setVerticalJustification(Vex.Flow.Annotation.VerticalJustify.BOTTOM));
    // }

    vf.draw();

    // ****************************
    
    let y0 = st.getBottomLineBottomY();
    let y1 = st.getTopLineTopY();

    let startX = st.getNoteStartX();
    let epsilon = notes[0].getModifierStartXY().x - startX;

    // function drawLine(x, width=1, color="#000", dashed=true) {
    //     let newElement = document.createElementNS("http://www.w3.org/2000/svg", 'path');
    //     newElement.setAttribute("d", `M${x} ${y0} L${x} ${y1}`);
    //     newElement.setAttribute("stroke-width", `${width}px`);
    //     newElement.setAttribute("stroke", color);
    //     if (dashed)
    //         newElement.setAttribute("stroke-dasharray", "4 2");

    //     document.getElementById("boo").children[0].appendChild(newElement);
    //     return newElement;
    // }

    function drawLine(x, width=1, color="#000", dashed=true) {
        let newElement = document.createElementNS("http://www.w3.org/2000/svg", 'line');
        
        newElement.setAttribute("x1", x);
        newElement.setAttribute("y1", y0);
        newElement.setAttribute("x2", x);
        newElement.setAttribute("y2", y1);

        newElement.setAttribute("stroke-width", `${width}px`);
        newElement.setAttribute("stroke", color);
        if (dashed)
            newElement.setAttribute("stroke-dasharray", "4 2");

        document.getElementById("boo").children[0].appendChild(newElement);
        return newElement;
    }

    // ********************************

    let indexBeforeDividers = [];
    for (let i = 0, j = 0; i < iqaa.rhythm.length; i++) {
        if (iqaa.rhythm[i] == '|') {
            indexBeforeDividers.push(j);
        } else {
            j++;
        }
    }

    let drawAllDividers = false;
    for (let i = 0; i < notes.length; i++) {
        if (drawAllDividers || indexBeforeDividers.includes(i)) {
            drawLine(notes[i].getModifierStartXY().x - epsilon);
        }
    }
    // drawLine(notes[notes.length-1].getModifierStartXY().x - epsilon + notes[notes.length-1].formatterMetrics.space.used, 3);
    // drawLine(st.end_x)

    // ***********************************

    // let values = notes.map(i => 1024/i.duration);
    let values = notes.map(i => i.intrinsicTicks);
    let valuesSum = values.reduce((a, b) => a + b, 0);

    let X = notes.map(i => i.getModifierStartXY().x - epsilon);
    X.push(st.end_x);

    function tToX(t) {
        let temp = t * valuesSum;
        let i = 0;
        for (; i < notes.length && values[i] < temp; i++) {
            temp -= values[i];
        }
        
        return (X[i+1] - X[i]) * (temp/values[i]) + X[i];
    }

    // **************************************************************

    let cursor = drawLine(tToX(0), 1, "red", false);
    // let bpm ;
    let T = 0;

    function refreshCursor() {
        let x = tToX(T/1000);
        cursor.setAttribute('x1', x);
        cursor.setAttribute('x2', x);

        // Play Music
        let div = 1000/iqaa.time[0];
        if (T % div <= 5) {
            switch (iqaa.rhythm.replaceAll('|', '')[Math.round(T / div)]) {
                case 'D':
                    soundD.play();
                    break;
                    
                case 'T':
                    soundT.play();
                    break;
            }
            
        }

        T += 10;
        T %= 1000;
    }

    var soundD = new Audio('D.wav');
    var soundT = new Audio('T.wav');


    setInterval(refreshCursor, 70);







    function drawRect(obj) {
        let newElement = document.createElementNS("http://www.w3.org/2000/svg", 'rect');
        
        newElement.setAttribute("x", obj.x);
        newElement.setAttribute("y", obj.y);
        newElement.setAttribute("width", obj.w);
        newElement.setAttribute("height", obj.h);

        newElement.setAttribute("stroke-width", `${1}px`);
        newElement.setAttribute("stroke", 'red');

        document.getElementById("boo").children[0].appendChild(newElement);
        return newElement;
    }

</script>

